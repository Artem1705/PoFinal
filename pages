import tkinter as tk
from tkinter import messagebox
from func import get_rates, convert, load_history, load_favorites, save_favorites
import matplotlib.pyplot as plt
from func import get_history

BG_COLOR = "#121212"
TEXT_COLOR = "white"
CARD_COLOR = "#1E1E1E"
BTN_COLOR = "#2A2A2A"

ALL_CURRENCIES = ["USD", "EUR", "RUB", "GBP", "JPY", "CNY", "AUD", "CAD", "CHF"]


def create_pages(container):

    frames = {}

    converter_from = tk.StringVar()
    converter_to = tk.StringVar()

    # =====================================
    # 1Ô∏è‚É£ –í–ê–õ–Æ–¢–´
    # =====================================
    currencies_page = tk.Frame(container, bg=BG_COLOR)

    title = tk.Label(currencies_page, text="–ö—É—Ä—Å –≤–∞–ª—é—Ç (USD)",
                     bg=BG_COLOR, fg=TEXT_COLOR,
                     font=("Arial", 26))
    title.pack(pady=20)

    rates_frame = tk.Frame(currencies_page, bg=BG_COLOR)
    rates_frame.pack()

    def show_graph(currency, base_currency):

        history = get_history(base_currency, currency, days=30)

        if not history:
            messagebox.showerror("–û—à–∏–±–∫–∞", "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫")
            return

        dates = [item[0] for item in history]
        values = [item[1] for item in history]

        plt.figure(figsize=(8, 4))
        plt.plot(dates, values)
        plt.xticks(rotation=45)
        plt.title(f"{currency} –∫ {base_currency} (30 –¥–Ω–µ–π)")
        plt.tight_layout()
        plt.show()

    def load_rates():
        for w in rates_frame.winfo_children():
            w.destroy()
        fav = load_favorites()
        rates = get_rates(fav[0])
        if not rates:
            return

        base_currency = fav[0] if fav else "USD"

        for cur in ALL_CURRENCIES:
            if cur == fav[0]:
                continue

            card = tk.Frame(rates_frame,
                            bg=CARD_COLOR,
                            width=520,
                            height=55)
            card.pack(pady=6)
            card.pack_propagate(False)

            # –í–∞–ª—é—Ç–∞
            tk.Label(card,
                     text=cur,
                     bg=CARD_COLOR,
                     fg="white",
                     font=("Arial", 16)).pack(side="left", padx=20)

            # –ö—É—Ä—Å
            tk.Label(card,
                     text=f"{rates[cur]}",
                     bg=CARD_COLOR,
                     fg="white",
                     font=("Arial", 16)).pack(side="left", padx=40)

            graph_btn = tk.Button(card,
                                  text="üìà",
                                  bg=BTN_COLOR,
                                  fg="white",
                                  bd=0,
                                  font=("Arial", 14),
                                  command=lambda c=cur, b=base_currency: show_graph(c, b))
            graph_btn.pack(side="right", padx=20)

            # hover —ç—Ñ—Ñ–µ–∫—Ç –¥–ª—è –∫–Ω–æ–ø–∫–∏
            graph_btn.bind("<Enter>",
                           lambda e, btn=graph_btn: btn.config(bg="#3A3A3A"))
            graph_btn.bind("<Leave>",
                           lambda e, btn=graph_btn: btn.config(bg=BTN_COLOR))

    currencies_page.place(relwidth=1, relheight=1)
    frames["–í–∞–ª—é—Ç—ã"] = currencies_page

    # =====================================
    # 2Ô∏è‚É£ –ö–û–ù–í–ï–†–¢–ï–†
    # =====================================
    converter_page = tk.Frame(container, bg=BG_COLOR)

    tk.Label(converter_page, text="–ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä",
             bg=BG_COLOR, fg=TEXT_COLOR,
             font=("Arial", 26)).pack(pady=20)

    amount_entry = tk.Entry(converter_page,
                            bg=CARD_COLOR,
                            fg="white",
                            insertbackground="white",
                            relief="flat",
                            font=("Arial", 16),
                            width=20)
    amount_entry.pack(pady=10)

    from_menu = tk.OptionMenu(converter_page, converter_from, *ALL_CURRENCIES)
    to_menu = tk.OptionMenu(converter_page, converter_to, *ALL_CURRENCIES)

    for menu in (from_menu, to_menu):
        menu.config(bg=CARD_COLOR, fg="white", relief="flat", width=15)

    from_menu.pack(pady=5)
    to_menu.pack(pady=5)

    result_label = tk.Label(converter_page,
                            text="",
                            bg=BG_COLOR,
                            fg="white",
                            font=("Arial", 20))
    result_label.pack(pady=10)

    def do_convert():
        try:
            amount = float(amount_entry.get())
        except:
            messagebox.showerror("–û—à–∏–±–∫–∞", "–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ")
            return

        result = convert(amount,
                         converter_from.get(),
                         converter_to.get())

        if result:
            result_label.config(
                text=f"{amount} {converter_from.get()} = {result} {converter_to.get()}"
            )

    tk.Button(converter_page,
              text="–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å",
              bg=BTN_COLOR,
              fg="white",
              bd=0,
              font=("Arial", 14),
              command=do_convert).pack(pady=10)

    converter_page.place(relwidth=1, relheight=1)
    frames["–ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä"] = converter_page

    # =====================================
    # 3Ô∏è‚É£ –ò–ó–ë–†–ê–ù–ù–û–ï (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫—É—Ä—Å)
    # =====================================
    fav_page = tk.Frame(container, bg=BG_COLOR)
    fav_frame = tk.Frame(fav_page, bg=BG_COLOR)
    fav_frame.pack(pady=40)

    def refresh_fav():
        for w in fav_frame.winfo_children():
            w.destroy()

        fav = load_favorites()
        rates = get_rates("USD")

        for cur in fav:
            if rates and cur in rates:
                tk.Label(fav_frame,
                         text=f"1 USD = {rates[cur]} {cur}",
                         bg=BG_COLOR,
                         fg="white",
                         font=("Arial", 18)).pack(pady=6)

    fav_page.place(relwidth=1, relheight=1)
    frames["–ò–∑–±—Ä–∞–Ω–Ω–æ–µ"] = fav_page

    # =====================================
    # 4Ô∏è‚É£ –ò–°–¢–û–†–ò–Ø
    # =====================================
    history_page = tk.Frame(container, bg=BG_COLOR)
    history_frame = tk.Frame(history_page, bg=BG_COLOR)
    history_frame.pack(pady=20)

    def refresh_history():
        for w in history_frame.winfo_children():
            w.destroy()

        for item in reversed(load_history()[-15:]):
            tk.Label(history_frame,
                     text=f"{item['date']}   {item['amount']} {item['from']} ‚Üí {item['result']} {item['to']}",
                     bg=BG_COLOR,
                     fg="white",
                     font=("Arial", 14)).pack(pady=4)

    history_page.place(relwidth=1, relheight=1)
    frames["–ò—Å—Ç–æ—Ä–∏—è"] = history_page

    # =====================================
    # 5Ô∏è‚É£ –ù–ê–°–¢–†–û–ô–ö–ò
    # =====================================
    settings_page = tk.Frame(container, bg=BG_COLOR)

    tk.Label(settings_page, text="–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ –≤–∞–ª—é—Ç—ã",
             bg=BG_COLOR, fg="white",
             font=("Arial", 22)).pack(pady=20)

    vars_dict = {}
    fav = load_favorites()

    for cur in ALL_CURRENCIES:
        var = tk.BooleanVar(value=cur in fav)
        chk = tk.Checkbutton(settings_page,
                             text=cur,
                             variable=var,
                             bg=BG_COLOR,
                             fg="white",
                             selectcolor=BG_COLOR,
                             activebackground=BG_COLOR,
                             font=("Arial", 14))
        chk.pack(anchor="w", padx=200)
        vars_dict[cur] = var

    def save_settings():
        selected = [c for c, v in vars_dict.items() if v.get()]
        save_favorites(selected)
        messagebox.showinfo("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ", "–ò–∑–±—Ä–∞–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ")

    tk.Button(settings_page,
              text="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å",
              bg=BTN_COLOR,
              fg="white",
              bd=0,
              font=("Arial", 14),
              command=save_settings).pack(pady=20)

    settings_page.place(relwidth=1, relheight=1)
    frames["–ù–∞—Å—Ç—Ä–æ–π–∫–∏"] = settings_page

    # ---------- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ ----------
    def refresh_all():
        load_rates()
        refresh_fav()
        refresh_history()

        fav = load_favorites()
        if fav:
            converter_from.set(fav[0])
        else:
            converter_from.set("USD")

        converter_to.set("USD")

    refresh_all()

    return frames, refresh_all
